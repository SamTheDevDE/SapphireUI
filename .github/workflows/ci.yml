name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

# Add top-level permissions for the workflow
permissions:
  contents: read

jobs:
  luacheck:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Lua
      uses: leafo/gh-actions-lua@v10
      with:
        luaVersion: "5.2"
    - name: Set up LuaRocks
      uses: leafo/gh-actions-luarocks@v4
    - name: Add LuaRocks to PATH
      run: echo "$HOME/.luarocks/bin" >> $GITHUB_PATH
    - name: Install luacheck
      run: luarocks install luacheck
    - name: Run luacheck
      run: luacheck src examples install.lua
      working-directory: ${{ github.workspace }}

  create_pr:
    needs: luacheck
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    runs-on: ubuntu-latest
    # Grant permissions for this specific job
    permissions:
      contents: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Create Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if ! gh pr list --base main --head dev --json number | grep -q '[0-9]'; then
          gh pr create --base main --head dev --title "Merge dev into main" --body "Automated PR to merge dev into main"
        else
          echo "Pull request from dev to main already exists."
        fi

  # This job now only builds the site and uploads it as an artifact
  build:
    needs: luacheck
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Pages
      id: pages
      uses: actions/configure-pages@v5
    - name: Generate JSON Manifest
      run: |
        BRANCH_NAME=${{ github.ref_name }}
        # The artifact needs an index.html file at the root
        touch index.html
        mkdir -p $BRANCH_NAME
        echo '{' > $BRANCH_NAME/install_manifest.json
        echo '  "files": [' >> $BRANCH_NAME/install_manifest.json
        find src -type f -name "*.lua" | sed -e 's/^/    "/' -e 's/$/"/' | paste -sd, - >> $BRANCH_NAME/install_manifest.json
        echo '' >> $BRANCH_NAME/install_manifest.json
        echo '  ]' >> $BRANCH_ANCHE_NAME/install_manifest.json
        echo '}' >> $BRANCH_NAME/install_manifest.json
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  # This new job handles the deployment
  deploy:
    needs: build
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && github.event_name == 'push'
    # Grant permissions for the deployment
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4